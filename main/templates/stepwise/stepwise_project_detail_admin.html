{% extends 'header.html' %}

{% load staticfiles %}
{% block title %}
	<title>GRMW Stepwise</title>
{% endblock%}
{% block head %}
	<link rel="stylesheet" href="{% static 'CSS/stepwise/style.css' %}" type="text/css">
{% endblock %}

{% block content %}
	<div class="stepwise_project_detail">
		<div class="mainImage">
			<img src="{% static 'images/stepwise/mainImage.png' %}">
			<h2>Stepwise - {{ project.prospectus_id.title }}</h2>
		</div>
		<table style="width: 100%;">
			<tr style="width: 100%;">
				<th style="vertical-align:top;">
					<div class="columnA">
						<div class="navBox">
							<h3>TABLE OF CONTENTS</h3>
							<ul class="navBoxLinks">
								<li><a href="javascript: scroll('#about_step');">Current Step</a>
								<li><a href="javascript: scroll('#project_details');">Project Details</a></li>
								<li><a href="javascript: scroll('#documents');">Documents</a></li>
								<li><a href="javascript: scroll('#comments');">Comments</a></li>
							</ul>
						</div>
						<div id="nav_menu_links">
							<a href="/stepwise/stepwise_portal_admin"><div class="back_to_stepwise menu_button link_button">Back to Stepwise Admin Portal</div></a>
						</div>
					</div>
				</th>
				<th style="vertical-align:top;">
					<div class="columnB">
						{% if project.current_step %}
						<center>
							<p class="stepTracker">
							{% if project.current_step == 1 %}
								Step {{project.current_step}} of 7 (Prospectus)</p>
							{% elif project.current_step == 2 %}
								Step {{project.current_step}} of 7 (Review)</p>
							{% elif project.current_step == 3 %}
								Step {{project.current_step}} of 7 (Draft Proposal)</p>
							{% elif project.current_step == 4 %}
								Step {{project.current_step}} of 7 (Site Visit & Feedback Loop)</p>
							{% elif project.current_step == 5 %}
								Step {{project.current_step}} of 7 (Final Draft)</p>
							{% elif project.current_step == 6 %}
								Step {{project.current_step}} of 7 (Approval)</p>
							{% elif project.current_step == 7 %}
								Step {{project.current_step}} of 7 (Final Decision)
							{% endif %}
						</center>
						{% endif %}
						<div style="height: 2vw; margin-right: 2vw; margin-left:2vw;margin-top: .5vw;background: #d0d0d0;" class="progress">
							  <div class="progress-bar" role="progressbar" aria-valuenow="0"
							  aria-valuemin="0" aria-valuemax="100" style="width:0%">
							  </div>
						</div>

						<h3 id="about_step" class='stylized_heading'>
							{% if project.current_step == 1 %}
								Step {{project.current_step}} of 7 (Prospectus)
							{% elif project.current_step == 2 %}
								Step {{project.current_step}} of 7 (Review)
							{% elif project.current_step == 3 %}
								Step {{project.current_step}} of 7 (Draft Proposal)
							{% elif project.current_step == 4 %}
								Step {{project.current_step}} of 7 (Site Visit & Feedback Loop)
							{% elif project.current_step == 5 %}
								Step {{project.current_step}} of 7 (Final Draft)
							{% elif project.current_step == 6 %}
								Step {{project.current_step}} of 7 (Approval)
							{% elif project.current_step == 7 %}
								Step {{project.current_step}} of 7 (Final Decision)
							{% endif %}
						</h3>
						<div class="content">
							{% if project.current_step == 1 %}
								<p>
									The prospectus for this opportunity is not yet finished.
								</p>
								<p><span class="normal">
									When the owner of this opportunity generates a prospectus, a notification will be sent to projects@grmw.org.
								</span></p>
							{% elif project.current_step == 2 %}
								<p>
									The prospectus is ready for review!
								</p>
								<p><span class="normal">
									Once you have finished reviewing the prospectus, please select one of the two buttons below. 'Approve' will prompt the owner of this opportunity to submit a draft proposal whereas 'Deny' will send them back to the first step and prompt the user to review their prospectus for resubmission. If you select 'Deny', it is recommended that you leave a comment below to alert the user as to why their prospectus was rejected.<br><br>
								</span></p>
								<center>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button approve" value="Approve">Approve</button>
								</form>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button deny" value="Deny">Deny</button>
								</form>
								</center>
							{% elif project.current_step == 3 %}
								<p>
									A Draft Proposal has not yet been submitted for this opportunity. Responsibility is currently on the owner of this opportunity to submit a draft proposal.
								</p><br><br>
								<p><span class="normal">
									It is possible that the owner of this opportunity has submitted a draft proposal through the OWEB application process. If this is believed to be the case, please verify the status of the application through OWEB and select 'Approve' or 'Deny' from the buttons below.<br><br>

									Selecting 'Approve' will move this opportunity to the next phase in the stepwise process (The Site Visit & Feedback Loop) whereas 'Deny' will send the user back to the previous step and prompt them to submit a new draft proposal. If you select 'Deny', it is recommended that you leave a comment below to alert the user as to why their draft proposal was rejected<br><br>
								</span></p>
								<center>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button approve" value="Approve">Approve</button>
								</form>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button deny" value="Deny">Deny</button>
								</form>
								</center>
							{% elif project.current_step == 4 %}
								<p>
									By this point a draft proposal should have been submitted for this opportunity. If a draft proposal does not exist in the documents section below, it is likely that the owner of this opportunity has a pending application through the OWEB application process.
								</p>
								<p><span class="normal">
									During this phase, the Implementation Team and Opportunity Lead should be discussing the technical and biological merits of this opportunity while on site.<br><br>

									Once a site visit has been conducted, the Opportunity Lead should recieve a written site visit report prepared by GRMW that incorporates the Implementation Team recommendations.<br><br>

									Once the draft proposal has been reviewed, and a site visit has been conducted, please select from the two options below.<br><br>

									Selecting 'Approve' will move this opportunity to the next phase in the stepwise process (Final Draft), prompting the owner of this opportunity to submit a revised proposal. Selecting 'Deny' will send the user back to the previous step and prompt them to revise their draft proposal. If you select 'Deny', it is recommended that you leave a comment below to alert the user as to why their draft proposal was rejected.
								</span></p>
								<center>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button approve" value="Approve">Approve</button>
								</form>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button deny" value="Deny">Deny</button>
								</form>
								</center>
							{% elif project.current_step == 5 %}
								<p>
									The owner of this opportunity has been prompted to submit a final draft of their project proposal.
								</p>
								<p><span class="normal">
									Once the owner of this opportunity has submitted their final draft of the project proposal, a notification will be sent to projects@grmw.org.
								</span></p>
							{% elif project.current_step == 6 %}
								<p>
									The owner of this opportunity has submitted a final draft of their project proposal and is currently awaiting a final decision.
								</p>
								<p><span class="normal">
									Once the GRMW Board of Directors has reviewed the final draft of the project proposal, select the appropriate decision from the buttons below.<br><br>

									In order to provide consistent feedback for the owner of this opportunity, it is recommended that the letter detailing the Board's decision also be uploaded to this opportunity at this time.<br><br>

									Selecting 'Approve' represents that the GRMW Board of Directors has elected to approve this project for funding. Selecting 'Deny' represents that the GRMW Board of Directors has elected NOT to fund this project.<br><br>
								</span></p>
								<center>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button approve" value="Approve">Approve</button>
								</form>
								<form class="approve-deny" method="POST" action="#">
									<button class="link_button deny" value="Deny">Deny</button>
								</form>
								</center>
							{% elif project.current_step == 7 %}
								<p>
									{% if project.final_approval_id.approval_flag == True %}
										This project has been successfully approved for funding!
									{% else %}
										This project not been approved for funding.
									{% endif %}
								</p>
							{% endif %}	
						</div>

						<h3 id="project_details" class='stylized_heading'>Project Details</h3>
						<div class="content">
							<p>
							Title: <span class="normal">{{ project.prospectus_id.title }}</span><br>
							Technical Contact Name:<span class="normal"> {{ project.prospectus_id.tech_contact_name }}</span><br>
							Opportunity Lead:<span class="normal"> {{ project.prospectus_id.opp_lead_name }}</span><br>
							Description: <span class="normal">{{ project.prospectus_id.project_description|linebreaksbr }}</span><br>
							</p>					
						</div>

						<h3 id="documents" class='stylized_heading'>Documents</h3>
						<div class="content">
							{% if prospectus %}
								<p>Click a link below to begin downloading the associated document.</p>
								<a href="/{{prospectus.file}}" type="application/pdf" download><div class="link_button document_link">Prospectus</div></a>
							{% else %}
								<center><p>There are no documents on file for this project.</p></center>
							{% endif %}
							{% if draft_files %}
								{% for draft in draft_files %}
									<a href="/{{draft.draft_file}}" download><div class="link_button document_link">{{draft.draft_title}}</div></a>
								{% endfor %}
							{% endif %}
						</div>

						<h3 id="comments" class='stylized_heading'>Comments</h3>
						<div class="content">
							<div class="comment_box">
								{% if comments %}
										{% for comment in comments %}
											{% if comment.user_id.id == request.user.id %}
												<div class="comment">
													<p style="padding-bottom: .5vw;">
														From: <span class="normal">{{comment.user_id.first_name}} {{comment.user_id.last_name}}</span><br>
														Subject: <span class="normal">{{comment.subject}}</span>
													</p>
													<div class="normal less_separation">
														{{comment.content|linebreaks}}
													</div><br>
													<div class="attachment_box">
														{% if comment.attachment %}
															<span class="bold smallFont">Attachment:<br/></span><a class="attachment_link" href="/{{comment.attachment}}" download>{{comment.attachment.file.name}}</a>
														{% endif %}
													</div>
												</div>
											{% else %}
												<div class="other-comment">
													<p style="padding-bottom:.5vw;">
														From: <span class="normal">{{comment.user_id.first_name}} {{comment.user_id.last_name}}</span><br>
														Subject: <span class="normal">{{comment.subject}}</span>
													</p>
													<div class="normal less_separation">
														{{comment.content|linebreaks}}
													</div><br>
													<div class="attachment_box">
														{% if comment.attachment %}
														<span class="bold smallFont">Attachment:<br/></span>
														<a class="attachment_link" href="/{{comment.attachment}}" download>
															{{comment.attachment.file.name}}
														</a>
														{% endif %}
													</div>
												</div>
											{% endif %}
										{% endfor %}
								{% else %}
									<center><p>You have no comments</p></center>
								{% endif %}
							</div>

							<div id="comment_form" style="border-top:.1vw solid black">
								{% if comment_form %}
								<form enctype="multipart/form-data" method="POST" action="/stepwise/stepwise_comment_admin/{{project.id}}/">{% csrf_token %}
									{{ comment_form.as_p }}
									<button id="submit_comment" class="link_button" type="submit">Submit</button>
								</form>
								{% endif %}
							</div>
						</div>
					</div>
				</th>
			</tr>
		</table>		
	</div>
<script>
	$(document).ready(function(){
		var widthInPX = $(window).width();
		var twoVW = Math.round(widthInPX*.02);
		var navHeight = $(".logologin").height();
		var navmenulinks = $(".mainImage").height();
		$(window).on('scroll', function(){
			if(window.pageYOffset > (twoVW*3+navHeight+navmenulinks)){
				if(window.pageYOffset < $(".columnB").height()){
					$(".navBox").css('margin-top', ((($(window).scrollTop())-(twoVW*2)-navHeight-navmenulinks)+"px"));
				}
			}
			else if(window.pageYOffset < (twoVW+navHeight)){
				$(".navBox").css('margin-top', (twoVW+"px"));
			}
		});

		{% if project.current_step %}
			var percentage = Math.ceil(({{project.current_step}}/7)*100);
			$(".progress-bar").attr('aria-valuenow', percentage)
			$(".progress-bar").attr('style', 'width: '+percentage+'%')
		{% endif %}

		$("#generate_prospectus").click(function(e){
			return window.confirm("Are you sure you wish to generate another prospectus? If you do, your previous prospectus will be overwritten.")
		});

		$("#comment_form label").hide();
		$('#comment_form label[for="id_attachment"]').show();

		$('.comment_box').scrollTop($('.comment_box')[0].scrollHeight);

		//prepend upload icon to upload label
		$('#comment_form label[for="id_attachment"]').html("<img class='upload_icon' src='{% static 'images/stepwise/upload.png'%}'/>  Upload Attachment");

		var id_attachment = document.querySelectorAll( '#id_attachment' );
		Array.prototype.forEach.call( id_attachment, function( input )
		{
			var label	 = $('#comment_form label[for="id_attachment"]');
			labelVal = label.html;
			console.log("made it")
			input.addEventListener( 'change', function( e )
			{
				console.log("something changed: ")
				var fileName = '';
				if( this.files && this.files.length > 1 )
					fileName = ( this.getAttribute( 'data-multiple-caption' ) || '' ).replace( '{count}', this.files.length );
				else
					fileName = e.target.value.split( '\\' ).pop();

				if( fileName )
					$('#comment_form label[for="id_attachment"]').html("Attachment: "+fileName);
				else
					$('#comment_form label[for="id_attachment"]').html("<img class='upload_icon' src='{% static 'images/stepwise/upload.png'%}'/>  Upload Attachment");
			});
		});

		//use filename instead of path for all attachments
		attachments = $(".attachment_link");
		for(var i=0; i < attachments.length; i++){
			filename = attachments[i].innerHTML 
			filename = filename.split('\\');
			filename = filename[filename.length-1];
			filename = filename.replace(/\s/g,'');
			if(filename != ''){
				attachments[i].innerHTML = "Download: "+filename;
			}
		}

		//style parent of upload button (can't be done with css)
		$('label[for="id_attachment"]').parent().css('max-width', '30vw');
		$('label[for="id_attachment"]').parent().css('display', 'inline-block');
		$('label[for="id_attachment"]').parent().css('verical-align', 'top');
		$('label[for="id_attachment"]').parent().css('margin-bottom', '2vw');
	});

	function scroll(t){
		$('html, body').animate({
			scrollTop: $(t).offset().top
		}, 500);
	}
</script>
{% endblock %}